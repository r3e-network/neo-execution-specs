# Neo Execution Specs - ä»£ç å®¡è®¡æŠ¥å‘Š

**å®¡è®¡æ—¥æœŸ**: 2025-02-04  
**å®¡è®¡å‘˜**: Claude (Anthropic)  
**é¡¹ç›®ç‰ˆæœ¬**: Neo N3 v3.9.1 æ‰§è¡Œè§„èŒƒ  
**ä»£ç ç»Ÿè®¡**: ~200 æºæ–‡ä»¶, ~16,000 è¡Œä»£ç , 736 æµ‹è¯•é€šè¿‡

---

## æ‰§è¡Œæ‘˜è¦

æœ¬å®¡è®¡å¯¹ `neo-execution-specs` é¡¹ç›®è¿›è¡Œäº†å…¨é¢å®¡æŸ¥ï¼Œè¯¥é¡¹ç›®æ˜¯ Neo N3 åè®®çš„ Python å‚è€ƒå®žçŽ°ã€‚é¡¹ç›®æ•´ä½“è´¨é‡è‰¯å¥½ï¼Œä»£ç ç»“æž„æ¸…æ™°ï¼Œæµ‹è¯•è¦†ç›–çŽ‡è¾ƒé«˜ã€‚ä½†å‘çŽ°äº†ä¸€äº›éœ€è¦å…³æ³¨çš„é—®é¢˜ï¼Œä¸»è¦é›†ä¸­åœ¨ï¼š

1. **éƒ¨åˆ†åŠŸèƒ½ä½¿ç”¨ç®€åŒ–å®žçŽ°**ï¼ˆä¸­ç­‰ä¸¥é‡ï¼‰
2. **BLS12-381 å¯†ç å­¦å®žçŽ°ä¸å®Œæ•´**ï¼ˆé«˜ä¸¥é‡ï¼‰
3. **æŸäº›å®‰å…¨å…³é”®å‡½æ•°ç¼ºå°‘å®Œæ•´éªŒè¯**ï¼ˆé«˜ä¸¥é‡ï¼‰
4. **ç¼ºå°‘éƒ¨åˆ† Neo N3 åŠŸèƒ½**ï¼ˆä¸­ç­‰ä¸¥é‡ï¼‰

---

## é—®é¢˜åˆ—è¡¨

### ðŸ”´ é«˜ä¸¥é‡åº¦é—®é¢˜

#### 1. ApplicationEngine ä¸­çš„ç­¾åéªŒè¯è¢«ç®€åŒ–

**ä½ç½®**: `src/neo/smartcontract/application_engine.py`

**é—®é¢˜**: `_runtime_check_witness` å’Œ `_crypto_check_sig` æ–¹æ³•å§‹ç»ˆè¿”å›ž `True`ï¼Œè¿™åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­æ˜¯ä¸¥é‡çš„å®‰å…¨æ¼æ´žã€‚

```python
def _runtime_check_witness(self, engine: "ApplicationEngine") -> None:
    """Check witness for account/contract."""
    hash_or_pubkey = self.pop()
    # Simplified: always return true for testing
    self.push(Integer(1))

def _crypto_check_sig(self, engine: "ApplicationEngine") -> None:
    """Check ECDSA signature."""
    signature = self.pop()
    pubkey = self.pop()
    message = self.pop()
    # Simplified: return true
    self.push(Integer(1))
```

**å»ºè®®**: å®žçŽ°å®Œæ•´çš„ç­¾åéªŒè¯é€»è¾‘ï¼Œä½¿ç”¨ `neo.crypto.ecdsa.verify_signature`ã€‚

---

#### 2. BLS12-381 å¯†ç å­¦å®žçŽ°ä¸å®Œæ•´

**ä½ç½®**: `src/neo/crypto/bls12_381/`

**é—®é¢˜**: BLS12-381 å®žçŽ°ä½¿ç”¨å ä½ç¬¦ä»£ç ï¼Œpairing æ“ä½œè¿”å›žç®€åŒ–ç»“æžœã€‚

```python
# src/neo/crypto/bls12_381/pairing.py
# This is a simplified placeholder implementation
# Simplified: create deterministic output from inputs
```

**å½±å“**: 
- æ— æ³•æ­£ç¡®éªŒè¯ BLS ç­¾å
- é›¶çŸ¥è¯†è¯æ˜Žç›¸å…³åŠŸèƒ½æ— æ³•ä½¿ç”¨
- ä¸Ž Neo C# å®žçŽ°ä¸å…¼å®¹

**å»ºè®®**: 
- é›†æˆ `py_ecc` æˆ– `blspy` åº“
- æˆ–å®žçŽ°å®Œæ•´çš„ BLS12-381 ç®—æœ¯

---

#### 3. åˆçº¦è°ƒç”¨æœªå®Œæ•´å®žçŽ°

**ä½ç½®**: `src/neo/smartcontract/application_engine.py`

**é—®é¢˜**: `_contract_call` æ–¹æ³•åªæ˜¯æŽ¨é€ NULLï¼Œæ²¡æœ‰å®žé™…è°ƒç”¨åˆçº¦ã€‚

```python
def _contract_call(self, engine: "ApplicationEngine") -> None:
    """Call another contract."""
    call_flags = CallFlags(self.pop().get_integer())
    method = self.pop().get_string()
    contract_hash = self.pop()
    # Simplified: just push null
    self.push(NULL)
```

**å»ºè®®**: å®žçŽ°å®Œæ•´çš„åˆçº¦è°ƒç”¨é€»è¾‘ï¼ŒåŒ…æ‹¬ï¼š
- ä»Žå­˜å‚¨åŠ è½½åˆçº¦
- éªŒè¯è°ƒç”¨æƒé™
- åˆ›å»ºæ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡
- å¤„ç†è¿”å›žå€¼

---

### ðŸŸ  ä¸­ç­‰ä¸¥é‡åº¦é—®é¢˜

#### 4. å­˜å‚¨æ“ä½œæœªæŒä¹…åŒ–

**ä½ç½®**: `src/neo/smartcontract/application_engine.py`

**é—®é¢˜**: å­˜å‚¨ syscalls (`_storage_get`, `_storage_put`, `_storage_delete`) æ²¡æœ‰å®žé™…æ“ä½œå­˜å‚¨ã€‚

```python
def _storage_get(self, engine: "ApplicationEngine") -> None:
    """Get value from storage."""
    key = self.pop()
    ctx_item = self.pop()
    # Return null for now (no persistence)
    self.push(NULL)
```

**å»ºè®®**: è¿žæŽ¥åˆ° `MemorySnapshot` æˆ–å®žé™…å­˜å‚¨åŽç«¯ã€‚

---

#### 5. NeoToken._refresh_committee æ–¹æ³•ç¼ºå¤±

**ä½ç½®**: `src/neo/native/neo_token.py`

**é—®é¢˜**: `on_persist` è°ƒç”¨äº† `_refresh_committee` æ–¹æ³•ï¼Œä½†è¯¥æ–¹æ³•æœªå®šä¹‰ã€‚

```python
def on_persist(self, engine: Any) -> None:
    """Called when a block is being persisted."""
    m = engine.protocol_settings.committee_members_count
    if engine.persisting_block.index % m == 0:
        self._refresh_committee(engine)  # æ–¹æ³•æœªå®šä¹‰
```

**å»ºè®®**: å®žçŽ° `_refresh_committee` æ–¹æ³•ã€‚

---

#### 6. ECPoint è§£ç ç®€åŒ–

**ä½ç½®**: `src/neo/types/ec_point.py`

**é—®é¢˜**: åŽ‹ç¼©ç‚¹è§£ç è¿”å›ž `y=0`ï¼Œè¿™æ˜¯ä¸æ­£ç¡®çš„ã€‚

```python
return cls(x=x, y=0)  # Simplified
```

**å»ºè®®**: å®žçŽ°å®Œæ•´çš„ç‚¹è§£åŽ‹ç¼©ç®—æ³•ã€‚

---

#### 7. å­—ç¬¦ä¸²é•¿åº¦è®¡ç®—ç®€åŒ–

**ä½ç½®**: `src/neo/native/std_lib.py`

**é—®é¢˜**: `str_len` æ–¹æ³•æ²¡æœ‰æ­£ç¡®å¤„ç† Unicode å­—å½¢ç°‡ã€‚

```python
def str_len(self, s: str) -> int:
    # Count grapheme clusters (simplified - counts code points for now)
```

**å»ºè®®**: ä½¿ç”¨ `grapheme` åº“æˆ–å®žçŽ°å®Œæ•´çš„å­—å½¢ç°‡åˆ†å‰²ã€‚

---

### ðŸŸ¡ ä½Žä¸¥é‡åº¦é—®é¢˜

#### 8. é™¤æ³•å’Œå–æ¨¡è¿ç®—çš„ç¬¦å·å¤„ç†

**ä½ç½®**: `src/neo/vm/instructions/numeric.py`

**é—®é¢˜**: Python çš„ `//` å’Œ `%` è¿ç®—ç¬¦ä¸Ž C# çš„è¡Œä¸ºä¸åŒï¼ˆPython å‘è´Ÿæ— ç©·å–æ•´ï¼ŒC# å‘é›¶å–æ•´ï¼‰ã€‚ä»£ç å°è¯•ä¿®æ­£ä½†å¯èƒ½æœ‰è¾¹ç•Œæƒ…å†µã€‚

```python
def div(engine: ExecutionEngine, instruction: Instruction) -> None:
    # Python's // does floor division, C# does truncation
    if (x1 < 0) != (x2 < 0) and x1 % x2 != 0:
        result = x1 // x2 + 1
    else:
        result = x1 // x2
```

**å»ºè®®**: æ·»åŠ æ›´å¤šè¾¹ç•Œæµ‹è¯•ç”¨ä¾‹ï¼Œç¡®ä¿ä¸Ž Neo C# å®žçŽ°ä¸€è‡´ã€‚

---

#### 9. ç¼ºå°‘ Gas è®¡é‡çš„å®Œæ•´å®žçŽ°

**ä½ç½®**: å¤šä¸ªæ–‡ä»¶

**é—®é¢˜**: è™½ç„¶æœ‰ `add_gas` æ–¹æ³•ï¼Œä½†å¾ˆå¤šæ“ä½œæ²¡æœ‰æ­£ç¡®è®¡è´¹ã€‚

**å»ºè®®**: 
- ä¸ºæ¯ä¸ª opcode æ·»åŠ æ­£ç¡®çš„ gas æ¶ˆè€—
- å®žçŽ° `ExecutionEngineLimits.assert_shift` ç­‰é™åˆ¶æ£€æŸ¥

---

#### 10. å¼‚å¸¸æ¶ˆæ¯å¯èƒ½æ³„éœ²ä¿¡æ¯

**ä½ç½®**: å¤šä¸ªæ–‡ä»¶

**é—®é¢˜**: æŸäº›å¼‚å¸¸æ¶ˆæ¯åŒ…å«è¯¦ç»†çš„å†…éƒ¨çŠ¶æ€ä¿¡æ¯ã€‚

**å»ºè®®**: åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­ä½¿ç”¨é€šç”¨é”™è¯¯æ¶ˆæ¯ã€‚

---

## ç¼ºå¤±åŠŸèƒ½æ¸…å•

### VM å±‚

| åŠŸèƒ½ | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|------|--------|
| CALLT (Token è°ƒç”¨) | âŒ æœªå®žçŽ° | é«˜ |
| å®Œæ•´çš„ Gas è®¡é‡ | âš ï¸ éƒ¨åˆ† | é«˜ |
| VM è°ƒè¯•å™¨æ”¯æŒ | âŒ æœªå®žçŽ° | ä½Ž |
| JumpTable ä¼˜åŒ– | âŒ æœªå®žçŽ° | ä½Ž |

### æ™ºèƒ½åˆçº¦å±‚

| åŠŸèƒ½ | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|------|--------|
| å®Œæ•´çš„åˆçº¦è°ƒç”¨ | âŒ æœªå®žçŽ° | é«˜ |
| å­˜å‚¨æŒä¹…åŒ– | âŒ æœªå®žçŽ° | é«˜ |
| è¿­ä»£å™¨å®Œæ•´å®žçŽ° | âš ï¸ éƒ¨åˆ† | ä¸­ |
| NEF éªŒè¯ | âš ï¸ éƒ¨åˆ† | ä¸­ |
| Manifest æƒé™æ£€æŸ¥ | âŒ æœªå®žçŽ° | ä¸­ |

### Native åˆçº¦

| åˆçº¦ | çŠ¶æ€ | ç¼ºå¤±åŠŸèƒ½ |
|------|------|----------|
| NeoToken | âš ï¸ 90% | `_refresh_committee`, å®Œæ•´æŠ•ç¥¨å¥–åŠ±è®¡ç®— |
| GasToken | âœ… 95% | å®Œæ•´çš„ `on_persist` |
| PolicyContract | âœ… 95% | - |
| ContractManagement | âš ï¸ 85% | å®Œæ•´çš„ NEF/Manifest éªŒè¯ |
| OracleContract | âš ï¸ 80% | å®Œæ•´çš„å“åº”å¤„ç† |
| RoleManagement | âš ï¸ 85% | è§’è‰²éªŒè¯ |
| CryptoLib | âš ï¸ 70% | BLS12-381 å®Œæ•´å®žçŽ° |
| StdLib | âœ… 95% | - |
| LedgerContract | âš ï¸ 80% | å®Œæ•´çš„åŒºå—/äº¤æ˜“æŸ¥è¯¢ |
| Notary | âš ï¸ 75% | å®Œæ•´çš„ Notary æµç¨‹ |

### å¯†ç å­¦

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜Ž |
|------|------|------|
| SHA256/RIPEMD160 | âœ… å®Œæˆ | ä½¿ç”¨ hashlib |
| ECDSA (secp256r1) | âœ… å®Œæˆ | ä½¿ç”¨ cryptography åº“ |
| ECDSA (secp256k1) | âœ… å®Œæˆ | ä½¿ç”¨ cryptography åº“ |
| Ed25519 | âš ï¸ éƒ¨åˆ† | éœ€è¦å¤–éƒ¨åº“ |
| BLS12-381 | âŒ å ä½ç¬¦ | éœ€è¦å®Œæ•´å®žçŽ° |
| Keccak256 | âš ï¸ éƒ¨åˆ† | ä¾èµ–å¯é€‰åº“ |

### ç½‘ç»œå±‚

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜Ž |
|------|------|------|
| Transaction | âœ… å®Œæˆ | åºåˆ—åŒ–/ååºåˆ—åŒ– |
| Block | âœ… å®Œæˆ | åŸºæœ¬ç»“æž„ |
| Header | âœ… å®Œæˆ | åŸºæœ¬ç»“æž„ |
| Witness | âœ… å®Œæˆ | åºåˆ—åŒ–/ååºåˆ—åŒ– |
| Signer | âœ… å®Œæˆ | åºåˆ—åŒ–/ååºåˆ—åŒ– |
| äº¤æ˜“å±žæ€§ | âš ï¸ éƒ¨åˆ† | ç¼ºå°‘éƒ¨åˆ†å±žæ€§ç±»åž‹ |
| P2P æ¶ˆæ¯ | âš ï¸ æ¡†æž¶ | ä»…å®šä¹‰äº†æ¶ˆæ¯ç±»åž‹ |

---

## æ”¹è¿›å»ºè®®

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰

1. **ä¿®å¤å®‰å…¨å…³é”®å‡½æ•°**
   - å®žçŽ°å®Œæ•´çš„ `_runtime_check_witness`
   - å®žçŽ°å®Œæ•´çš„ `_crypto_check_sig` å’Œ `_crypto_check_multisig`

2. **è¿žæŽ¥å­˜å‚¨å±‚**
   - å°† ApplicationEngine è¿žæŽ¥åˆ° MemorySnapshot
   - å®žçŽ°å­˜å‚¨ syscalls çš„å®Œæ•´é€»è¾‘

3. **å®žçŽ°åˆçº¦è°ƒç”¨**
   - å®Œæˆ `_contract_call` æ–¹æ³•
   - æ·»åŠ è°ƒç”¨æƒé™éªŒè¯

### ä¸­æœŸï¼ˆ1-2 æœˆï¼‰

4. **å®Œå–„ Native åˆçº¦**
   - å®žçŽ° NeoToken çš„ `_refresh_committee`
   - å®Œå–„ OracleContract çš„å“åº”å¤„ç†
   - æ·»åŠ å®Œæ•´çš„ NEF/Manifest éªŒè¯

5. **BLS12-381 å®žçŽ°**
   - é›†æˆ `py_ecc` æˆ– `blspy`
   - æˆ–å®žçŽ°å®Œæ•´çš„ BLS12-381 ç®—æœ¯

6. **å¢žåŠ æµ‹è¯•è¦†ç›–**
   - æ·»åŠ ä¸Ž Neo C# å®žçŽ°çš„ä¸€è‡´æ€§æµ‹è¯•
   - æ·»åŠ è¾¹ç•Œæ¡ä»¶æµ‹è¯•
   - æ·»åŠ æ¨¡ç³Šæµ‹è¯•

### é•¿æœŸï¼ˆ3+ æœˆï¼‰

7. **æ€§èƒ½ä¼˜åŒ–**
   - å®žçŽ° JumpTable ä¼˜åŒ–
   - è€ƒè™‘ä½¿ç”¨ Cython åŠ é€Ÿå…³é”®è·¯å¾„

8. **å®Œæ•´çš„ P2P ç½‘ç»œ**
   - å®žçŽ°å®Œæ•´çš„ P2P æ¶ˆæ¯å¤„ç†
   - å®žçŽ°èŠ‚ç‚¹åŒæ­¥é€»è¾‘

---

## æ€»ä½“è¯„ä¼°

### ä¼˜ç‚¹

1. **ä»£ç è´¨é‡é«˜**: ä»£ç ç»“æž„æ¸…æ™°ï¼Œå‘½åè§„èŒƒï¼Œæ³¨é‡Šå……åˆ†
2. **æµ‹è¯•è¦†ç›–å¥½**: 736 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œè¦†ç›–äº†ä¸»è¦åŠŸèƒ½
3. **æ–‡æ¡£å®Œå–„**: ROADMAP.md æ¸…æ™°è®°å½•äº†è¿›åº¦å’Œè®¡åˆ’
4. **ç±»åž‹æç¤º**: å¹¿æ³›ä½¿ç”¨ Python ç±»åž‹æç¤ºï¼Œæé«˜å¯è¯»æ€§
5. **æ¨¡å—åŒ–è®¾è®¡**: å„æ¨¡å—èŒè´£æ¸…æ™°ï¼Œæ˜“äºŽæ‰©å±•

### éœ€è¦æ”¹è¿›

1. **å®‰å…¨å…³é”®å‡½æ•°**: ç­¾åéªŒè¯ç­‰å®‰å…¨åŠŸèƒ½éœ€è¦å®Œæ•´å®žçŽ°
2. **å¯†ç å­¦å®Œæ•´æ€§**: BLS12-381 éœ€è¦å®Œæ•´å®žçŽ°
3. **å­˜å‚¨é›†æˆ**: éœ€è¦è¿žæŽ¥å®žé™…å­˜å‚¨åŽç«¯
4. **åˆçº¦è°ƒç”¨**: éœ€è¦å®žçŽ°å®Œæ•´çš„åˆçº¦è°ƒç”¨é€»è¾‘

### è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜Ž |
|------|------|------|
| ä»£ç è´¨é‡ | â­â­â­â­ | ç»“æž„æ¸…æ™°ï¼Œé£Žæ ¼ä¸€è‡´ |
| æµ‹è¯•è¦†ç›– | â­â­â­â­ | 736 æµ‹è¯•ï¼Œè¦†ç›–ä¸»è¦åŠŸèƒ½ |
| åŠŸèƒ½å®Œæ•´æ€§ | â­â­â­ | æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼Œéƒ¨åˆ†ç®€åŒ– |
| å®‰å…¨æ€§ | â­â­ | å…³é”®éªŒè¯å‡½æ•°éœ€è¦å®Œå–„ |
| æ–‡æ¡£ | â­â­â­â­ | ROADMAP å’Œæ³¨é‡Šå®Œå–„ |
| **æ€»ä½“** | **â­â­â­Â½** | è‰¯å¥½çš„åŸºç¡€ï¼Œéœ€è¦å®Œå–„å…³é”®åŠŸèƒ½ |

---

## ç»“è®º

`neo-execution-specs` æ˜¯ä¸€ä¸ªé«˜è´¨é‡çš„ Neo N3 å‚è€ƒå®žçŽ°é¡¹ç›®ï¼Œä¸ºç†è§£ Neo åè®®æä¾›äº†æ¸…æ™°çš„ Python ä»£ç ã€‚é¡¹ç›®å·²å®Œæˆçº¦ 70-80% çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†åœ¨å®‰å…¨å…³é”®åŠŸèƒ½ï¼ˆç­¾åéªŒè¯ã€åˆçº¦è°ƒç”¨ï¼‰å’Œå¯†ç å­¦ï¼ˆBLS12-381ï¼‰æ–¹é¢éœ€è¦è¿›ä¸€æ­¥å®Œå–„ã€‚

å»ºè®®åœ¨å°†æ­¤å®žçŽ°ç”¨äºŽä»»ä½•ç”Ÿäº§çŽ¯å¢ƒä¹‹å‰ï¼Œä¼˜å…ˆè§£å†³é«˜ä¸¥é‡åº¦é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯ç­¾åéªŒè¯å’Œåˆçº¦è°ƒç”¨çš„å®Œæ•´å®žçŽ°ã€‚

---

*å®¡è®¡æŠ¥å‘Šç”± Claude (Anthropic) ç”Ÿæˆ*  
*æœ€åŽæ›´æ–°: 2025-02-04*
