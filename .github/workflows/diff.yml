name: Diff Compatibility Testing

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      target_network:
        description: "Network(s) to validate"
        required: false
        type: choice
        options:
          - all
          - mainnet
          - testnet
        default: all
      mainnet_csharp_rpc:
        description: "Optional override for MainNet Neo v3.9.1 RPC endpoint"
        required: false
        default: ""
      mainnet_neogo_rpc:
        description: "Optional override for MainNet NeoGo RPC endpoint"
        required: false
        default: ""
      testnet_csharp_rpc:
        description: "Optional override for TestNet Neo v3.9.1 RPC endpoint"
        required: false
        default: ""
      testnet_neogo_rpc:
        description: "Optional override for TestNet NeoGo RPC endpoint"
        required: false
        default: ""
      neo_rs_rpc:
        description: "Optional neo-rs RPC endpoint for tri-client diff (workflow_dispatch only)"
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: diff-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  compatibility-matrix:
    strategy:
      fail-fast: false
      matrix:
        include:
          - network: mainnet
            csharp_candidates: "http://seed1.neo.org:10332 http://seed2.neo.org:10332 http://seed3.neo.org:10332 http://seed4.neo.org:10332 http://seed5.neo.org:10332"
            neogo_candidates: "http://rpc3.n3.nspcc.ru:10332 http://rpc2.n3.nspcc.ru:10332 http://rpc1.n3.nspcc.ru:10332"
            expected_network: "860833102"
            expected_msperblock: "15000"
          - network: testnet
            csharp_candidates: "http://seed1t5.neo.org:20332 http://seed2t5.neo.org:20332 http://seed3t5.neo.org:20332 http://seed4t5.neo.org:20332 http://seed5t5.neo.org:20332"
            neogo_candidates: "http://rpc.t5.n3.nspcc.ru:20332 http://rpc1.t5.n3.nspcc.ru:20332 http://rpc2.t5.n3.nspcc.ru:20332 http://rpc3.t5.n3.nspcc.ru:20332"
            expected_network: "894710606"
            expected_msperblock: "3000"
    runs-on: ubuntu-latest
    name: ${{ matrix.network }} compatibility

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[all]"

      - name: Select healthy reference RPC endpoints
        id: select-rpc
        env:
          INPUT_MAINNET_CSHARP_RPC: ${{ github.event.inputs.mainnet_csharp_rpc }}
          INPUT_MAINNET_NEOGO_RPC: ${{ github.event.inputs.mainnet_neogo_rpc }}
          INPUT_TESTNET_CSHARP_RPC: ${{ github.event.inputs.testnet_csharp_rpc }}
          INPUT_TESTNET_NEOGO_RPC: ${{ github.event.inputs.testnet_neogo_rpc }}
          CSHARP_CANDIDATES: ${{ matrix.csharp_candidates }}
          NEOGO_CANDIDATES: ${{ matrix.neogo_candidates }}
          EXPECTED_NETWORK: ${{ matrix.expected_network }}
          EXPECTED_MSPERBLOCK: ${{ matrix.expected_msperblock }}
          MATRIX_NETWORK: ${{ matrix.network }}
        run: |
          set -euo pipefail

          if [ "${MATRIX_NETWORK}" = "mainnet" ]; then
            csharp_override="${INPUT_MAINNET_CSHARP_RPC}"
            neogo_override="${INPUT_MAINNET_NEOGO_RPC}"
          else
            csharp_override="${INPUT_TESTNET_CSHARP_RPC}"
            neogo_override="${INPUT_TESTNET_NEOGO_RPC}"
          fi

          if [ -n "${csharp_override}" ]; then
            csharp_candidates="${csharp_override}"
          else
            csharp_candidates="${CSHARP_CANDIDATES}"
          fi

          if [ -n "${neogo_override}" ]; then
            neogo_candidates="${neogo_override}"
          else
            neogo_candidates="${NEOGO_CANDIDATES}"
          fi

          payload='{"jsonrpc":"2.0","id":1,"method":"getversion","params":[]}'

          select_rpc() {
            label="$1"
            ua_token="$2"
            candidates="$3"

            selected=""

            for rpc in ${candidates}; do
              echo "Checking ${label}: ${rpc}" >&2
              response="$(curl -sS --max-time 12 -H 'Content-Type: application/json' -d "$payload" "$rpc" || true)"
              if [ -z "$response" ]; then
                continue
              fi

              if RESPONSE="$response" UA_TOKEN="$ua_token" EXPECTED_NETWORK="$EXPECTED_NETWORK" EXPECTED_MSPERBLOCK="$EXPECTED_MSPERBLOCK" python -c "import json, os, sys; data=json.loads(os.environ.get('RESPONSE','{}')); result=data.get('result', {}); protocol=result.get('protocol', {}); ua=result.get('useragent', ''); network=protocol.get('network'); msperblock=protocol.get('msperblock'); sys.exit(0 if os.environ['UA_TOKEN'] in ua and str(network) == os.environ['EXPECTED_NETWORK'] and str(msperblock) == os.environ['EXPECTED_MSPERBLOCK'] else 1)"; then
                selected="$rpc"
                break
              fi
            done

            if [ -z "$selected" ]; then
              echo "No healthy ${label} RPC endpoint found for ${MATRIX_NETWORK}" >&2
              exit 1
            fi

            printf '%s' "$selected"
          }

          csharp_rpc="$(select_rpc "Neo v3.9.1" "Neo:3.9.1" "${csharp_candidates}")"
          neogo_rpc="$(select_rpc "NeoGo" "NEO-GO" "${neogo_candidates}")"

          echo "Using C#: ${csharp_rpc}"
          echo "Using NeoGo: ${neogo_rpc}"
          echo "CSHARP_RPC=${csharp_rpc}" >> "$GITHUB_ENV"
          echo "NEOGO_RPC=${neogo_rpc}" >> "$GITHUB_ENV"
          echo "csharp_rpc=${csharp_rpc}" >> "$GITHUB_OUTPUT"
          echo "neogo_rpc=${neogo_rpc}" >> "$GITHUB_OUTPUT"

      - name: Verify protocol parity between C# and NeoGo
        env:
          EXPECTED_NETWORK: ${{ matrix.expected_network }}
          EXPECTED_MSPERBLOCK: ${{ matrix.expected_msperblock }}
        run: |
          set -euo pipefail

          payload='{"jsonrpc":"2.0","id":1,"method":"getversion","params":[]}'
          curl --compressed -sS --max-time 12 -H 'Content-Type: application/json' -d "$payload" "$CSHARP_RPC" > csharp-getversion.json
          curl --compressed -sS --max-time 12 -H 'Content-Type: application/json' -d "$payload" "$NEOGO_RPC" > neogo-getversion.json

          python - <<'PY'
          import json
          import os

          with open("csharp-getversion.json", "r", encoding="utf-8") as f:
              csharp = json.load(f)
          with open("neogo-getversion.json", "r", encoding="utf-8") as f:
              neogo = json.load(f)

          def protocol_subset(payload: dict) -> dict:
              result = payload.get("result", {})
              protocol = result.get("protocol", {})

              hardforks = protocol.get("hardforks", [])
              if isinstance(hardforks, list):
                  normalized_hardforks = sorted(
                      [h for h in hardforks if isinstance(h, dict)],
                      key=lambda item: (item.get("name", ""), item.get("blockheight", 0)),
                  )
              else:
                  normalized_hardforks = []

              return {
                  "network": protocol.get("network"),
                  "msperblock": protocol.get("msperblock"),
                  "maxtraceableblocks": protocol.get("maxtraceableblocks"),
                  "maxtransactionsperblock": protocol.get("maxtransactionsperblock"),
                  "memorypoolmaxtransactions": protocol.get("memorypoolmaxtransactions"),
                  "validatorscount": protocol.get("validatorscount"),
                  "initialgasdistribution": protocol.get("initialgasdistribution"),
                  "hardforks": normalized_hardforks,
              }

          csharp_protocol = protocol_subset(csharp)
          neogo_protocol = protocol_subset(neogo)

          if csharp_protocol != neogo_protocol:
              raise SystemExit(
                  "C# and NeoGo protocol mismatch:\n"
                  + json.dumps({"csharp": csharp_protocol, "neogo": neogo_protocol}, indent=2)
              )

          expected_network = int(os.environ["EXPECTED_NETWORK"])
          expected_msperblock = int(os.environ["EXPECTED_MSPERBLOCK"])

          if csharp_protocol["network"] != expected_network:
              raise SystemExit(f"Unexpected network magic: {csharp_protocol['network']} != {expected_network}")

          if csharp_protocol["msperblock"] != expected_msperblock:
              raise SystemExit(f"Unexpected msperblock: {csharp_protocol['msperblock']} != {expected_msperblock}")

          hardfork_names = {entry.get("name") for entry in csharp_protocol["hardforks"] if isinstance(entry, dict)}
          if "Faun" not in hardfork_names:
              raise SystemExit("Faun hardfork missing in protocol.hardforks")
          PY

      - name: Run strict compatibility vectors (C# vs NeoGo)
        env:
          NEOGO_CANDIDATES: ${{ matrix.neogo_candidates }}
        run: |
          set -euo pipefail

          candidates="$NEOGO_RPC"
          for candidate in ${NEOGO_CANDIDATES}; do
            if [ "$candidate" != "$NEOGO_RPC" ]; then
              candidates="$candidates $candidate"
            fi
          done

          success=0
          for candidate in ${candidates}; do
            echo "Running neo-compat with NeoGo endpoint: ${candidate}"
            if timeout 45m neo-compat \
              --vectors tests/vectors/ \
              --csharp-rpc "$CSHARP_RPC" \
              --neogo-rpc "$candidate" \
              --output-dir reports \
              --prefix "compat-${{ matrix.network }}"; then
              echo "NEOGO_RPC=${candidate}" >> "$GITHUB_ENV"
              success=1
              break
            fi
            echo "neo-compat failed for ${candidate}, trying next endpoint" >&2
          done

          if [ "$success" -ne 1 ]; then
            echo "All NeoGo endpoint attempts failed for ${{ matrix.network }}" >&2
            exit 1
          fi

      - name: Run strict triplet compatibility vectors (optional C#/NeoGo/neo-rs)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.neo_rs_rpc != ''
        env:
          NEO_RS_RPC: ${{ github.event.inputs.neo_rs_rpc }}
        run: |
          set -euo pipefail
          timeout 60m neo-multicompat \
            --vectors tests/vectors/ \
            --csharp-rpc "$CSHARP_RPC" \
            --neogo-rpc "$NEOGO_RPC" \
            --neo-rs-rpc "$NEO_RS_RPC" \
            --output-dir reports \
            --prefix "compat-${{ matrix.network }}-triplet"

      - name: Upload compatibility reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compatibility-report-${{ matrix.network }}
          path: |
            reports/compat-${{ matrix.network }}-csharp.json
            reports/compat-${{ matrix.network }}-neogo.json
            reports/compat-${{ matrix.network }}-triplet-csharp.json
            reports/compat-${{ matrix.network }}-triplet-neogo.json
            reports/compat-${{ matrix.network }}-triplet-neo_rs.json
            csharp-getversion.json
            neogo-getversion.json
          retention-days: 30

      - name: Generate summary
        if: always()
        env:
          SELECTED_CSHARP_RPC: ${{ steps.select-rpc.outputs.csharp_rpc }}
          ACTIVE_NEOGO_RPC: ${{ env.NEOGO_RPC }}
          INPUT_NEO_RS_RPC: ${{ github.event.inputs.neo_rs_rpc }}
        run: |
          if [ -f "reports/compat-${{ matrix.network }}-csharp.json" ] && [ -f "reports/compat-${{ matrix.network }}-neogo.json" ]; then
            echo "## Compatibility Results (${{ matrix.network }})" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "C# endpoint: ${SELECTED_CSHARP_RPC}" >> "$GITHUB_STEP_SUMMARY"
            echo "NeoGo endpoint: ${ACTIVE_NEOGO_RPC}" >> "$GITHUB_STEP_SUMMARY"
            python3 - <<'PY' >> "$GITHUB_STEP_SUMMARY"
          import json
          from pathlib import Path

          def to_int(value):
              if isinstance(value, int):
                  return value
              if isinstance(value, str) and value.isdigit():
                  return int(value)
              return 0

          def summary(path: str):
              payload = json.loads(Path(path).read_text(encoding='utf-8'))
              raw = payload.get('summary', {})
              if not isinstance(raw, dict):
                  raw = {}
              return {
                  'total': to_int(raw.get('total', 0)),
                  'passed': to_int(raw.get('passed', 0)),
                  'failed': to_int(raw.get('failed', 0)),
                  'errors': to_int(raw.get('errors', 0)),
              }

          csharp = summary('reports/compat-${{ matrix.network }}-csharp.json')
          neogo = summary('reports/compat-${{ matrix.network }}-neogo.json')

          print('| Metric | C# | NeoGo |')
          print('|--------|----|-------|')
          print(f"| Total Tests | {csharp['total']} | {neogo['total']} |")
          print(f"| Passed | {csharp['passed']} | {neogo['passed']} |")
          print(f"| Failed | {csharp['failed']} | {neogo['failed']} |")
          print(f"| Errors | {csharp['errors']} | {neogo['errors']} |")
          PY
          fi

          if [ -f "reports/compat-${{ matrix.network }}-triplet-csharp.json" ] && [ -f "reports/compat-${{ matrix.network }}-triplet-neogo.json" ] && [ -f "reports/compat-${{ matrix.network }}-triplet-neo_rs.json" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Triplet Compatibility (C#/NeoGo/neo-rs)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "neo-rs endpoint: ${INPUT_NEO_RS_RPC}" >> "$GITHUB_STEP_SUMMARY"
            python3 - <<'PY' >> "$GITHUB_STEP_SUMMARY"
          import json
          from pathlib import Path

          def to_int(value):
              if isinstance(value, int):
                  return value
              if isinstance(value, str) and value.isdigit():
                  return int(value)
              return 0

          def load(path: str):
              return json.loads(Path(path).read_text(encoding='utf-8'))

          def summary(report):
              raw = report.get('summary', {})
              if not isinstance(raw, dict):
                  raw = {}
              return {
                  'total': to_int(raw.get('total', 0)),
                  'passed': to_int(raw.get('passed', 0)),
                  'failed': to_int(raw.get('failed', 0)),
                  'errors': to_int(raw.get('errors', 0)),
              }

          def indexed(report):
              out = {}
              for item in report.get('results', []) if isinstance(report.get('results'), list) else []:
                  if not isinstance(item, dict):
                      continue
                  vector = item.get('vector')
                  if not isinstance(vector, str) or not vector:
                      continue
                  match = bool(item.get('match', False))
                  diffs = [d for d in item.get('differences', []) if isinstance(d, dict)] if isinstance(item.get('differences'), list) else []
                  out[vector] = (match, diffs)
              return out

          def delta_count(left, right):
              li = indexed(left)
              ri = indexed(right)
              all_vectors = set(li) | set(ri)
              count = 0
              for vector in all_vectors:
                  lval = li.get(vector)
                  rval = ri.get(vector)
                  if lval is None or rval is None or lval != rval:
                      count += 1
              return count

          csharp_report = load('reports/compat-${{ matrix.network }}-triplet-csharp.json')
          neogo_report = load('reports/compat-${{ matrix.network }}-triplet-neogo.json')
          neo_rs_report = load('reports/compat-${{ matrix.network }}-triplet-neo_rs.json')

          csharp = summary(csharp_report)
          neogo = summary(neogo_report)
          neo_rs = summary(neo_rs_report)

          print('| Metric | C# | NeoGo | neo-rs |')
          print('|--------|----|-------|--------|')
          print(f"| Total Tests | {csharp['total']} | {neogo['total']} | {neo_rs['total']} |")
          print(f"| Passed | {csharp['passed']} | {neogo['passed']} | {neo_rs['passed']} |")
          print(f"| Failed | {csharp['failed']} | {neogo['failed']} | {neo_rs['failed']} |")
          print(f"| Errors | {csharp['errors']} | {neogo['errors']} | {neo_rs['errors']} |")

          print('')
          print('| Pair | Delta Vectors |')
          print('|------|----------------|')
          print(f"| C# vs NeoGo | {delta_count(csharp_report, neogo_report)} |")
          print(f"| C# vs neo-rs | {delta_count(csharp_report, neo_rs_report)} |")
          print(f"| NeoGo vs neo-rs | {delta_count(neogo_report, neo_rs_report)} |")
          PY
          fi
