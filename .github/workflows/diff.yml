name: Diff Testing

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      csharp_rpc:
        description: "Optional Neo v3.9.1 RPC endpoint"
        required: false
        default: ""

jobs:
  diff-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[all]"

      - name: Select Neo v3.9.1 RPC endpoint
        id: select-rpc
        env:
          INPUT_CSHARP_RPC: ${{ github.event.inputs.csharp_rpc }}
        run: |
          set -euo pipefail

          if [ -n "${INPUT_CSHARP_RPC}" ]; then
            candidates="${INPUT_CSHARP_RPC}"
          else
            candidates="http://seed1.neo.org:10332 http://seed2.neo.org:10332 http://seed3.neo.org:10332 http://seed4.neo.org:10332 http://seed5.neo.org:10332"
          fi

          selected=""
          payload='{"jsonrpc":"2.0","id":1,"method":"getversion","params":[]}'

          for rpc in ${candidates}; do
            echo "Checking ${rpc}"
            response="$(curl -sS --max-time 12 -H 'Content-Type: application/json' -d "$payload" "$rpc" || true)"
            if [ -z "$response" ]; then
              continue
            fi

            if RESPONSE="$response" python -c "import json, os, sys; data=json.loads(os.environ.get('RESPONSE','{}')); ua=data.get('result',{}).get('useragent',''); sys.exit(0 if 'Neo:3.9.1' in ua else 1)"; then
              selected="$rpc"
              break
            fi
          done

          if [ -z "$selected" ]; then
            echo "No healthy Neo v3.9.1 RPC endpoint found" >&2
            exit 1
          fi

          echo "Using ${selected}"
          echo "CSHARP_RPC=${selected}" >> "$GITHUB_ENV"
          echo "csharp_rpc=${selected}" >> "$GITHUB_OUTPUT"

      - name: Run diff tests
        run: |
          neo-diff \
            --vectors tests/vectors/ \
            --csharp-rpc "$CSHARP_RPC" \
            --output diff-report.json

      - name: Upload diff report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: diff-report
          path: diff-report.json
          retention-days: 30

      - name: Generate summary
        if: always()
        env:
          SELECTED_CSHARP_RPC: ${{ steps.select-rpc.outputs.csharp_rpc }}
        run: |
          if [ -f diff-report.json ]; then
            echo "## Diff Test Results" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "RPC endpoint: ${SELECTED_CSHARP_RPC}" >> "$GITHUB_STEP_SUMMARY"
            python -c "import json; data=json.load(open('diff-report.json')); s=data.get('summary', {}); print('| Metric | Value |'); print('|--------|-------|'); print(f\"| Total Tests | {s.get('total', 0)} |\"); print(f\"| Passed | {s.get('passed', 0)} |\"); print(f\"| Failed | {s.get('failed', 0)} |\"); print(f\"| Errors | {s.get('errors', 0)} |\"); print(f\"| Pass Rate | {s.get('pass_rate', '0.00%')} |\")" >> "$GITHUB_STEP_SUMMARY"
          fi
